@page "/product-detail/{ProductId}"
@using TCH.Data.Entities
@using TCH.WebServer.Services.Orders
@using TCH.WebServer.Services.Products

@inject IOrderService orderService
@inject IProductService productService
@inject NavigationManager navigationNavigation

<div class="page d-flex flex-row flex-column-fluid">
    <div class="wrapper d-flex flex-column flex-row-fluid" id="kt_wrapper">
        <TCH.WebServer.Shared.Header.Header></TCH.WebServer.Shared.Header.Header>
        <div class="content d-flex flex-column flex-column-fluid" id="kt_content">
            @if (order != null && product != null && orderDetail != null)
            {
                <div class="d-flex flex-column flex-column-fluid container-fluid" style="">
                    <!--begin::Post-->
                <div class="content flex-column-fluid" id="kt_content">
                        <!--begin::Stats-->
                    <div class="row g-6 g-xl-9">
                            <div class="col-lg-6 col-xxl-4">
                                <!--begin::Card-->
                            <div class="card h-200">
                                    <!--begin::Card body-->
                                <div class="card-body p-9">
                                        <a class="d-block overlay" data-fslightbox="lightbox-hot-sales" href="@("http://www.tchhost.somee.com/uploads" + product.LinkImage)">
                                            <!--begin::Image-->
                                        <div class="overlay-wrapper bgi-no-repeat bgi-position-center bgi-size-cover card-rounded " style="min-height: 250px;background-image:url(@("http://www.tchhost.somee.com/uploads" + product.LinkImage))"></div>
                                            <!--end::Image-->
                                            <!--begin::Action-->
                                        <div class="overlay-layer card-rounded bg-dark bg-opacity-25">
                                                <i class="bi bi-eye-fill fs-2x text-white"></i>
                                            </div>
                                            <!--end::Action-->
                                    </a>
                                    </div>
                                    <!--end::Card body-->
                            </div>
                                <!--end::Card-->
                        </div>
                            <div class="col-lg-6 col-xxl-4">
                                <!--begin::Budget-->
                            <div class="card ">
                                    <div class="card-body p-9">
                                        <div class="fs-2hx fw-bolder">@product.Price</div>
                                        <div class="fs-4 fw-bold text-gray-400 mb-7">@product.Name</div>
                                        @if (product.Sizes != null)
                                        {
                                            foreach (var size in product.Sizes)
                                            {
                                                <div class="separator separator-dashed"></div>
                                                <div class="fs-6 d-flex justify-content-between my-4">
                                                    <div class="fw-bold">@size.Name</div>
                                                    <div class="d-flex fw-bolder">
                                                        <!--begin::Svg Icon | path: icons/duotune/arrows/arr006.svg-->
                                            
                                                        @size.SubPrice
                                                    </div>
                                                    <button class="btn btn-outline-primary" style="" onclick="@(() => PickSize(size.ID))">+</button>
                                                </div>
                                            }
                                        }
                                    </div>
                                </div>
                                <!--end::Budget-->
                        </div>
                            <div class="col-lg-6 col-xxl-4" style="height:400px; overflow: scroll;">
                                
                                    <div class="dataTables_scrollBody" style="position: relative; overflow: auto; max-height: 400px; width: 100%;">
                                        <table class="table align-middle table-row-dashed fs-6 gy-5 dataTable no-footer" id="kt_ecommerce_edit_order_product_table" style="width: 100%;">
                                            <thead>
                                                <tr class="text-start text-gray-400 fw-bolder fs-7 text-uppercase gs-0" style="height: 1px;"><th class="w-25px pe-2 sorting_disabled" rowspan="1" colspan="1" style="width: 24.9844px; padding-top: 0px; padding-bottom: 0px; border-top-width: 0px; border-bottom-width: 0px; height: 0px;"><div class="dataTables_sizing" style="height: 0px; overflow: hidden;"></div></th><th class="min-w-200px sorting" aria-controls="kt_ecommerce_edit_order_product_table" rowspan="1" colspan="1" style="width: 362.938px; padding-top: 0px; padding-bottom: 0px; border-top-width: 0px; border-bottom-width: 0px; height: 0px;"><div class="dataTables_sizing" style="height: 0px; overflow: hidden;">Product</div></th><th class="min-w-100px text-end pe-5 sorting" aria-controls="kt_ecommerce_edit_order_product_table" rowspan="1" colspan="1" style="width: 197.828px; padding-top: 0px; padding-bottom: 0px; border-top-width: 0px; border-bottom-width: 0px; height: 0px;"><div class="dataTables_sizing" style="height: 0px; overflow: hidden;">Qty Remaining</div></th></tr>
                                            </thead>
                                            <!--begin::Table head-->
                                            <!--end::Table head-->
                                            <!--begin::Table body-->
                                                <tbody class="fw-bold text-gray-600">
                                                @if (product.Toppings != null)
                                                {
                                                foreach (var topping in product.Toppings)
                                                {

                                                <tr class="odd">
                                                    <!--begin::Checkbox-->
                                                    <td>
                                                        <div class="form-check form-check-sm form-check-custom form-check-solid">
                                                            <input class="form-check-input" type="checkbox" value="1">
                                                        </div>
                                                    </td>
                                                    <!--end::Checkbox-->
                                                    <!--begin::Product=-->
                                                    <td>
                                                        <div class="d-flex align-items-center" data-kt-ecommerce-edit-order-filter="product" data-kt-ecommerce-edit-order-id="product_1">
                                                   
                                                    <div class="ms-5">
                                                                <!--begin::Title-->
                                                        <a href="../../demo1/dist/apps/ecommerce/catalog/edit-product.html" class="text-gray-800 text-hover-primary fs-5 fw-bolder">@topping.Name</a>
                                                                <!--end::Title-->
                                                                <!--begin::Price-->
                                                        <div class="fw-bold fs-7">
                                                                    Price: $
                                                                    <span data-kt-ecommerce-edit-order-filter="price">@topping.SubPrice</span>
                                                                </div>
                                                                <!--end::Price-->
                                                                <!--begin::SKU-->
                                                        <div class="text-muted fs-7">SKU: 02639002</div>
                                                                <!--end::SKU-->
                                                    </div>
                                                        </div>
                                                    </td>
                                                    <!--end::Product=-->
                                                    <!--begin::Qty=-->
                                                        <td class="text-end pe-5" >
                                                            <input type="checkbox" @onchange="@(e => { AddTopping(@topping.ID, topping.SubPrice, e.Value); })">
                                                        </td>
                                                    <!--end::Qty=-->
                                                   </tr>
                                                }}
                                            </tbody>
                                            <!--end::Table body-->
                                        </table>
                                    </div>
                                
                            </div>
                            <div class="col-lg-6 col-xxl-4">
                                <EditForm Model="orderDetail">
                                    <div class="mb-10 fv-row fv-plugins-icon-container">
                                        <!--begin::Label-->
                                    <label class="required form-label">Lượng Đá</label>
                                        <!--end::Label-->
                                        <!--begin::Input-->
                                    <InputSelect @bind-Value="orderDetail.IcedType" class="form-control">
                                            @foreach (var ice in Enum.GetValues(typeof(IcedType)))
                                            {
                                            <option value="@ice">@ice</option>
                                            }
                                    </InputSelect>
                                    <!--end::Input-->
                                </div>
                                <div class="mb-10 fv-row fv-plugins-icon-container">
                                    <!--begin::Label-->
                                    <label class="required form-label">Lượng đường</label>
                                    <!--end::Label-->
                                    <!--begin::Input-->
                                    <InputSelect @bind-Value="orderDetail.SugarType" class="form-control">
                                        @foreach (var sugar in Enum.GetValues(typeof(SugarType)))
                                            {
                                            <option value="@sugar">@sugar</option>
                                            }
                                    </InputSelect>
                                    <!--end::Input-->
                                </div>
                                <div class="mb-10 fv-row fv-plugins-icon-container">
                                    <!--begin::Label-->
                                    <label class="required form-label required">Số lượng</label>
                                    <!--end::Label-->
                                    <!--begin::Input-->
                                    <InputNumber @bind-Value="orderDetail.Quantity" class="form-control">

                                    </InputNumber>
                                    <!--end::Input-->
                                </div>
                            </EditForm>

                        </div>

                    </div>
                    <div class="row g-6 g-xl-9 justify-content-center" style="margin-top: 30px">
                        @if (orderDetail != null && toppings != null)
                            {
                                <div class="card ">
                                    <div class="card-body p-9">
                                        <div class="fs-2hx fw-bolder">Sản phẩm - @product.Name ()</div>
                                        <div class="fs-4 fw-bold text-gray-400 mb-7">Size - @(SizePro)</div>
                                        <div class="fs-4 fw-bold text-primary text-gray-400 mb-7">Đồ đi kèm</div>
                                        @foreach (var topping in toppings)
                                        {
                                            <div class="fs-4 fw-bold text-gray-400 mb-7">@(topping.SubPrice)</div>
                                        }
                                        <div class="fs-4 fw-bold text-gray-400 mb-7">Giá trị - @(orderDetail.SubAmount)</div>

                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                    <!--end::Post-->

            </div>
            }
        </div>
        <div class="d-flex justify-content-end">
            <!--begin::Button-->
            <a href="../../demo1/dist/apps/ecommerce/catalog/products.html" id="kt_ecommerce_add_product_cancel" class="btn btn-light me-5">Cancel</a>
            <!--end::Button-->
            <!--begin::Button-->
            <button type="submit" id="kt_ecommerce_add_category_submit" class="btn btn-primary" onclick="@(() => OnSubmit())">
                <span class="indicator-label">Save Changes</span>
                <span class="indicator-progress">
                    Please wait...
                    <span class="spinner-border spinner-border-sm align-middle ms-2"></span>
                </span>
            </button>
            <!--end::Button-->
        </div>
    </div>
</div>

@code {
    [Parameter] public string ProductId { get; set; }
    private OrderRequest order;
    private ProductVm product;
    private OrderItem orderDetail;
    private List<OrderToppingItem> toppings = new List<OrderToppingItem>();
    private int quantity;
    private string SizePro = "S";
    protected override async Task OnParametersSetAsync()
    {
        var responseProduct = await productService.GetProductById(ProductId);
        product = responseProduct.Data;
        order = GbParameter.GbParameter.Order;
        orderDetail = new OrderItem()
            {

                ProductID = ProductId,
                SizeID = "6f6fc132-d92b-475f-98e3-0ba15e90706f",
                Quantity = 1,
                PriceProduct = product.Price,
                SubAmount = product.Price,
            };
        base.OnParametersSet();
    }
    public async Task AddTopping(string toppingId, double subPrice, object checkedValue)
    {
        if((bool)checkedValue){
            var topping = new OrderToppingItem()
            {
                ToppingID = toppingId,
                SubPrice = subPrice
            };
            toppings.Add(topping);
            orderDetail.SubAmount += subPrice;
            StateHasChanged();
        }
        else
        {
            var topping = new OrderToppingItem()
            {
                ToppingID = toppingId,
                SubPrice = subPrice
            };
            toppings.Remove(topping);
            orderDetail.SubAmount -= subPrice;
            StateHasChanged();
        }
    }
    public async Task PickSize(string size)
    {
        orderDetail.SizeID = size;
        var sizes = await productService.GetSizes();
        foreach (Size si in sizes.Items)
        {
            if (si.ID == size)
            {
                orderDetail.SubAmount -= orderDetail.PriceSize;
                orderDetail.PriceSize = si.SubPrice;
                orderDetail.SubAmount += si.SubPrice;
                SizePro = si.Name;
                StateHasChanged();
                break;
            }
        }
    }
    public async Task OnSubmit()
    {
        orderDetail.Toppings = toppings;
        orderDetail.SubAmount *= orderDetail.Quantity;
        order.OrderItems.Add(orderDetail);
        GbParameter.GbParameter.Order = order;
        navigationNavigation.NavigateTo("/dashboard");
    }
}
